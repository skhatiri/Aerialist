FROM skhatiri/px4

# --- Existing Python Setup (keep as is) ---
RUN sudo apt-get update -y &&\
    sudo apt-get install python3.8 python3-setuptools python3.8-dev -y &&\
    sudo update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.6 1 &&\
    sudo update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.7 2 &&\
    sudo update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.8 3
RUN python3 -m pip install --upgrade pip

#Setting up the current tool
# # COPY ./requirements.txt /src/aerialist/requirements.txt
# WORKDIR /workspaces/Aerialist
# RUN pip3 install -r requirements.txt
# RUN pip3 install --upgrade anyio==3.5.0
# # COPY . .
# RUN chmod +x ./aerialist/__main__.py
# COPY ./template.env ./.env
# RUN mkdir -p /io/ ./results/logs/ tmp/
# --- End Existing Python Setup ---

# --- Additions for VS Code Server Workaround ---

# Install patchelf 0.14.3
# Remove 'sudo' as RUN commands already execute as root.
# Add apt-get clean to reduce image size.
RUN apt-get update && apt-get install -y wget build-essential autoconf
RUN wget https://github.com/NixOS/patchelf/releases/download/0.14.3/patchelf-0.14.3.tar.gz && \
    tar -xzf patchelf-0.14.3.tar.gz && \
    cd patchelf-0.14.3 && \
    ./configure && make && make install && \
    rm -rf /patchelf-0.14.3.tar.gz patchelf-0.14.3 && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Copy the built sysroot into the container
# Ensure 'extracted_sysroot' directory from Phase 1 is in the same context as this Dockerfile
COPY ./extracted_sysroot /opt/sysroot

# Set environment variables for VS Code Server
ENV VSCODE_SERVER_CUSTOM_GLIBC_LINKER="/opt/sysroot/lib64/ld-linux-x86-64.so.2" \
    VSCODE_SERVER_CUSTOM_GLIBC_PATH="/opt/sysroot/lib64:/opt/sysroot/usr/lib64" \
    VSCODE_SERVER_PATCHELF_PATH="/usr/local/bin/patchelf"

# Ensure /usr/local/bin is in PATH for root or the user being used.
ENV PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

# --- Optional: ENTRYPOINT/CMD for your application ---
# ENTRYPOINT [ "./run.py" ]
# CMD [ "--help" ]FROM skhatiri/px4

# ENTRYPOINT [ "./run.py" ]
# CMD [ "--help" ]